<!doctype html>
<html lang="en">

<head>
  <title>Smart EVSE</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <style>
    body {
      text-shadow: 0 .05rem .1rem rgba(0, 0, 0, .5);
      box-shadow: inset 0 0 5rem rgba(0, 0, 0, .5);
      --bs-heading-color: rgba(255, 255, 255, 0.9);
    }

    .bg-body-tertiary {
      background-color: #27293D !important;
    }

    .shadow {
      box-shadow: 0 1px 20px 0 rgba(0, 0, 0, .1);
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      color: lightseagreen;
    }

    #version {
      font-size: medium;
    }

    svg {
      fill: cornflowerblue;
    }

    #evse_data .col .row>* {
      min-width: 130px !important;
    }

    i.bi {
      color: gray;
      vertical-align: top;
    }

    @media screen and (max-width: 420px) {

      .h5,
      h5 {
        font-size: 1.10rem;
      }

      #evse_data .col .row>* {
        min-width: 85px !important;
      }
    }
  </style>
  <style>
    .header {
      position: relative;
      text-align: center;
      background: linear-gradient(60deg, rgb(131, 12, 198) 0%, rgb(0, 172, 193) 100%);
      /*background: linear-gradient(60deg, rgba(84, 58, 183, 1) 0%, rgba(0, 172, 193, 1) 100%);*/
      /*background: linear-gradient(60deg, rgb(67, 177, 100) 0%, rgb(3, 13, 70) 100%);*/
    }

    .inner-header {
      width: 100%;
      margin: 15px 0 0 0;
      padding: 0;
      position: absolute;
    }

    .inner-header h3 {
      color: #fff;
      text-shadow: 1px 1px 1px rgb(0, 0, 0);
    }

    .waves {
      position: relative;
      width: 100%;
      height: 80px;
      margin-bottom: -7px;
      /*Fix for safari gap*/
      min-height: 80px;
      max-height: 150px;
    }

    .content {
      position: relative;
      height: 20vh;
      text-align: center;
      background-color: white;
    }

    /* Animation */

    .parallax>use {
      animation: move-forever 15s cubic-bezier(.55, .5, .45, .5) infinite;
    }

    .parallax>use:nth-child(1) {
      animation-delay: -2s;
      animation-duration: 5s;
    }

    .parallax>use:nth-child(2) {
      animation-delay: -3s;
      animation-duration: 8s;
    }

    .parallax>use:nth-child(3) {
      animation-delay: -4s;
      animation-duration: 11s;
    }

    .parallax>use:nth-child(4) {
      animation-delay: -5s;
      animation-duration: 18s;
    }

    @keyframes move-forever {
      0% {
        transform: translate3d(-90px, 0, 0);
      }

      100% {
        transform: translate3d(85px, 0, 0);
      }
    }

    /*Shrinking for mobile*/
    @media (max-width: 768px) {
      .waves {
        height: 60px;
        min-height: 60px;
      }

      .content {
        height: 30vh;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
  <script>
    //let endpoint = "/settings";
    let endpoint = 'http://192.168.1.160/settings.json';
    let initiated = false;

    function relativeTime(seconds) {
      let output = "";
      if (seconds < 60) {
        // Less than a minute has passed:
        output = `${seconds} seconds ago`;
      } else if (seconds < 3600) {
        // Less than an hour has passed:
        output = `${Math.floor(seconds / 60)} minutes ago`;
      } else if (seconds < 86400) {
        // Less than a day has passed:
        output = `${Math.floor(seconds / 3600)} hours ago`;
      } else if (seconds < 2620800) {
        // Less than a month has passed:
        output = `${Math.floor(seconds / 86400)} days ago`;
      } else if (seconds < 31449600) {
        // Less than a year has passed:
        output = `${Math.floor(seconds / 2620800)} months ago`;
      } else {
        // More than a year has passed:
        output = `${Math.floor(seconds / 31449600)} years ago`;
      }
      return output;
    }

    function loadData() {
      $.ajax({
        url: endpoint
      }).then(function (data) {
        try {
          if (!initiated) {
            initiated = true;
            $('#version').append(data.version);
          }

          if (data.controller.error) {
            $('#error').text(data.controller.errorText);
            $('[id=with_errors]').show();
          } else {
            $('[id=with_errors]').hide();
          }
          $('#vehicle_connected').html(data.controller.vehicleConnected ? "<i class=\"bi bi-plug text-warning\"></i><span class=\"text-warning\">Vehicle connected</span>" : "<i class=\"bi bi-ev-station\"></i> Vehicle not detected");
          if (data.controller.chargeCurrent >= 10) {
            $('#state').html("<i class=\"bi-battery-charging\"></i> ");
          }
          $('#state').append(data.controller.stateText);
          if (data.controller.solarStopTimer > 0) {
            $('#state').append(" <i>(stopping in " + data.controller.solarStopTimer + "s)</i>");
          }

          for (let x = 0; x <= 3; x++) {
            if (x == data.controller.mode) {
              $('#mode_' + x).removeClass("btn-outline-secondary");
              $('#mode_' + x).addClass("btn-bd-primary");
            } else {
              $('#mode_' + x).removeClass("btn-bd-primary");
              $('#mode_' + x).addClass("btn-outline-secondary");
            }
          }

          $('#mode').text(data.controller.modeText);
          $('#config').html(data.controller.config == 0 ? "<i class=\"bi bi-outlet\"></i> Socket" : "<i class=\"bi bi-ev-station\"></i> Fixed cable");
          $('#charge_current').text((data.controller.chargeCurrent / 10).toFixed(1) + "A");
          $('#temp').text(data.controller.temperature + "°C / " + data.controller.maxTemperature + "°C");
          $('#rfid').text((data.rfid.reader == 0) ? "Not installed" : "Enabled [" + data.rfid.statusText + "]");
          $('#rfid_access').text((data.rfid.accessBit == 0) ? "No access" : "Granted");

          $('#current_min').text(data.controller.minCurrent.toFixed(1) + "A");
          $('#current_max').text(data.controller.maxCurrent.toFixed(1) + "A");
          if (data.modbus.overrideCurrent > 0) {
            $('#override_current').text((data.modbus.overrideCurrent / 10).toFixed(1) + "A");
          }
          else {
            $('#override_current').text("--");
          }

          $('#cable_max').text(data.controller.cableMaxCapacity + "A");
          if (data.controller.chargeCurrent > 0) {
            let perc = (data.controller.chargeCurrent * 10) / data.controller.maxCurrent;
            //$('#progress h3').text("Charging at " + (data.controller.chargeCurrent / 10).toFixed(1) + "A");
            //$('#progress h3').html("<i class=\"bi-lightning-charge\"></i> Charging at " + perc.toFixed(1) + "% max power");
            $('#progress h3').html("<i class=\"bi-battery-charging\"></i> Charging at " + perc.toFixed(1) + "% max power");
            $('#progress').show();
          }
          else {
            $('#progress').hide();
          }

          $('#mainsmeter_description').text(data.modbus.mainsMeterText);
          $('#mainsmeter_phase_1').text((data.controller.Irms.L1 / 10).toFixed(1) + "A");
          $('#mainsmeter_phase_2').text((data.controller.Irms.L2 / 10).toFixed(1) + "A");
          $('#mainsmeter_phase_3').text((data.controller.Irms.L3 / 10).toFixed(1) + "A");

          if (data.modbus.lastCTResponseMillis > 0) {
            new Intl.RelativeTimeFormat('en', { style: 'narrow' });
            $('#p1_data_received').text(data.modbus.lastCTResponseMillis == -1 ? "--" : relativeTime(Math.round(data.modbus.lastCTResponseMillis / 1000)));
            $('[id=with_p1_api_data]').show();
          } else {
            //$('[id=with_p1_api_data]').hide();
          }

          if (data.modbus.evMeterText == "Disabled") {
            $('#with_evmeter').hide();
            $('#with_evmeter2').hide();
          } else {
            $('#with_evmeter').show();
            $('#with_evmeter2').show();
            $('#evmeter_description').text(data.modbus.evMeterText);
            $('#evmeter_power').text(data.modbus.powerMeasured.toFixed(1) + " kW");
            $('#evmeter_total_kwh').text(data.modbus.evMeterEnergy.toFixed(1) + " kWh");
            $('#evmeter_charged_kwh').text(data.modbus.energyCharged.toFixed(1) + " kWh");
          }
        } catch (error) {
          console.log(error);
        }

        setTimeout("loadData()", 5000);
      });
    }

    function activate(mode) {
      $.post("/settings?mode=" + mode);
    }

    function reboot() {
      if (confirm("Do you want to reboot?")) {
        $.post("/reboot");
      }
    }

    function update() {
      window.location.href = "/update";
    }

    function rawData() {
      window.location.href = "/settings";
    }

    $(document).ready(loadData);
  </script>
</head>

<body data-bs-theme="dark" class="d-block h-100">
  <div id="wrapper">
    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <div class="container-fluid">

          <div class="header" id="progress" style="display: none">
            <div class="inner-header">
              <h3 class="h5 fw-bold"></h3>
            </div>
            <!--Waves Container-->
            <div>
              <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
                <defs>
                  <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
                </defs>
                <g class="parallax">
                  <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.7" />
                  <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(255,255,255,0.5)" />
                  <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(255,255,255,0.3)" />
                  <use xlink:href="#gentle-wave" x="48" y="7" fill="#fff" />
                </g>
              </svg>
            </div>
            <!--Waves end-->
          </div>
          <!--Header ends-->

          <div class="row">

            <div class="mb-4" id="evse_data">
              <div class="card shadow h-100 py-0 bg-body-tertiary">
                <div class="card-body">
                  <div class="row g-0 align-items-center">
                    <div class="col me-2">
                      <h3 class="fw-bold mb-1">EVSE <span id="version">v</span></h3>
                      <div class="row g-0 align-items-center bg-light mb-2 ps-2" id="with_errors"
                        style="display: none;">
                        <div class="col-auto h5 mb-0 me-3 pb-2 pt-2 text-danger fw-bold">
                          <i class="bi bi-exclamation-octagon"></i> Error:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 pt-2 me-3 text-danger" id="error"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2" id="vehicle_connected">
                          <i class="bi bi-plug"></i>Vehicle connected
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-terminal"></i> Status:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="state"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-lightning-charge"></i> Charge:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="charge_current"></div>
                        </div>
                      </div>
                      <div class="row g-0">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-house-gear"></i> Mode:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="mode"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-thermometer-half"></i> Temp:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="temp"></div>
                        </div>
                      </div>
                      <div class="row g-0">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-gear"></i> Config:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="config"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center" id="show_rfid">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-credit-card"></i> RFID:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="rfid"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center" id="show_rfid">
                        <div class="col-auto mb-0 h5 mb-0 me-3 pb-2">
                          <i class="bi bi-unlock"></i> Access:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 pb-2 me-3 text-muted" id="rfid_access"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>



          </div>
          <!-- END ROW -->
          <div class="row">

            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card shadow h-100 py-0 bg-body-tertiary">
                <div class="card-body">
                  <div class="row g-0 align-items-center">
                    <div class="col">
                      <h6 class="fw-bold text-uppercase mb-1">Current Details</h6>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> Min:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="current_min"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> Max:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="current_max"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-code"></i> Override:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="override_current"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-plug"></i> Cable max:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="cable_max"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
              <div class="card shadow h-100 py-0 bg-body-tertiary">
                <div class="card-body">
                  <div class="row g-0 align-items-center">
                    <div class="col">
                      <h6 class="fw-bold text-uppercase mb-1">PV Meter</h6>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-speedometer2"></i> Type:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="mainsmeter_description">
                          </div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> L1:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="mainsmeter_phase_1"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> L2:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="mainsmeter_phase_2"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> L3:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="mainsmeter_phase_3"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center" id="with_p1_api_data">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-clock-history"></i> Last received:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="p1_data_received"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4" id="with_evmeter">
              <div class="card shadow h-100 py-0 bg-body-tertiary">
                <div class="card-body">
                  <div class="row g-0 align-items-center">
                    <div class="col">
                      <h6 class="fw-bold text-uppercase mb-1">EV Meter</h6>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-speedometer2"></i> Type:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="evmeter_description">
                          </div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> Power:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="evmeter_power"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-lightning-charge"></i> Total kWh:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="evmeter_total_kwh"></div>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-battery-half"></i> Charged kWh:
                        </div>
                        <div class="col">
                          <div class="h5 mb-0 text-muted text-end" id="evmeter_charged_kwh">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="mb-4">
              <div class="card shadow h-100 py-0 bg-body-tertiary">
                <div class="card-body">
                  <div class="row g-0 align-items-center">
                    <div class="col me-2">
                      <h4 class="fw-bold text-uppercase mb-1">Control</h4>
                      <div class="row g-0 align-items-center mb-3">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-house-gear"></i> Mode:
                        </div>
                      </div>
                      <div class="row g-0 align-items-center mb-3">
                        <div class="col">
                          <button id="mode_0" onclick="activate('0')" class="btn btn-outline-secondary me-2 mb-2"
                            type="button">NORMAL</button>
                          <button id="mode_1" onclick="activate('1')" class="btn btn-outline-secondary me-2 mb-2"
                            type="button">SMART</button>
                          <button id="mode_2" onclick="activate('2')" class="btn btn-outline-secondary me-2 mb-2"
                            type="button">SOLAR</button>
                        </div>
                      </div>
                      <div class="row g-0 align-items-center mb-3">
                        <div class="col-auto h5 mb-0 me-3">
                          <i class="bi bi-braces"></i> Actions:
                        </div>
                      </div>
                      <div class="row g-0 align-items-center mb-3">
                        <div class="col">
                          <button onclick="update()" class="btn btn-outline-secondary me-2 mb-2"
                            type="button">Update</button>
                          <button onclick="reboot()" class="btn btn-outline-secondary me-2 mb-2"
                            type="button">Reboot</button>
                          <button onclick="rawData()" class="btn btn-outline-secondary me-2 mb-2" type="button">Raw
                            Data</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>



        </div>
      </div>
    </div>
  </div>
</body>

</html>